name: Release Charts Dev GHCR

on:
  push:
    branches: [ develop ]
    paths:
      - "charts/kuber-agent/Chart.yaml"
  workflow_dispatch:

jobs:
  push-oci:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Helm
        uses: azure/setup-helm@v3

      - name: Package chart with dev version
        run: |
          set -euo pipefail
          CHART_DIR="charts/kuber-agent"
          BASE_VER="$(awk '/^version:/ {print $2}' "${CHART_DIR}/Chart.yaml")"
          DEV_VER="${BASE_VER}-dev.${GITHUB_SHA::7}"

          mkdir -p out
          helm package "${CHART_DIR}" \
            --version "${DEV_VER}" \
            --app-version "${DEV_VER}" \
            --destination out

          echo "DEV_VER=${DEV_VER}" >> "$GITHUB_ENV"

      - name: Login to GHCR
        run: |
          set -euo pipefail
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io \
            -u "${{ github.actor }}" --password-stdin

      - name: Push chart to GHCR (OCI)
        run: |
          set -euo pipefail
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"

          # IMPORTANT: Helm requires the ref be oci://.../<repo>, without chart name or tag
          # Chart name and version/tag are inferred from the package metadata.
          helm push out/*.tgz "oci://ghcr.io/${OWNER}/${REPO}-dev"
